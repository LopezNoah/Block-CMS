---
import BasicLayout from "../layouts/BasicLayout.astro";
import { type PageInsert } from "../lib/models/types";
import { db } from "../lib/drizzle";
import { pages } from "../lib/models/schema";
import Comp from "./partials/Pages/PageEntry.astro";
import { eq } from "drizzle-orm";

const possibleLayouts = ["FullWidth"];
const request = Astro.request;
const { id }  = Astro.props;

const page = db.select().from(pages).where(eq(pages.id, Number(id || 0)));

if (request.method === "POST") {
    //This is a form request and we need to validate/process the data.
    const formData = await request.formData();  

    const description = formData.get("description");
    const title = formData.get("title");
    const layout = formData.get("layout");

    if (typeof description !== "string" || typeof title !== "string" || typeof layout !== "string") {
        throw new Error("One of the form data values is incorrect");
    }

    const values: PageInsert = {
        description, title, layout
    };
    
    db.insert(pages).values(values).execute();

    const realPages = await db.select().from(pages).execute();
    console.log("pages", realPages);
}

---

<BasicLayout>
    <Comp  />
</BasicLayout>